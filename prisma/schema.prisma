// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
  previewFeatures = ["relationJoins"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String    @id @default(uuid()) @unique

  // Identit√©
  email          String    @unique
  passwordHash   String
  firstName      String?
  lastName       String?

  // R√¥le & permissions
  role           Role      @default(PME)
  isActive       Boolean   @default(true)


  

  // S√©curit√©
  lastLoginAt    DateTime?
  failedLogins   Int       @default(0)
  isLocked       Boolean   @default(false)
  tokens          RefreshToken[]
  // Audit & suivi
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  validatedAt         DateTime?
  verificationCode     String?
  codeExpires           DateTime?
  codeIsVerified         Boolean  @default(false)

  pme            PME?   
  activity          Activity[]  
  committeMember      CommitteeMember[]
  

}




model RefreshToken {
  id        String    @id @default(uuid())
  token     String    @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime  @default(now())
  revokedAt DateTime? // üëà NOUVEAU CHAMP
 
  user User @relation(fields: [userId], references: [id])
}


model PME {
  id          String   @id @default(uuid())

  /* --- Identit√© --- */
  name        String
  type        PMEType
  size        PMESize
  description String

  /* --- Contact --- */
  email       String   @unique
  phone       String
  website     String?
  logoUrl     String?
  logoId      String?

  /* --- Localisation --- */
  country        String           
  administrative Json?            
  city           String?           
  address        String

  /* --- R√¥le utilisateur --- */
  userRole    String?
  activityField   String

  /* --- Relations --- */
  projects    Project[]
  activity    Activity[]

  ownerId     String   @unique
  owner       User     @relation(fields: [ownerId], references: [id])

  /* --- Statut --- */
  isActive    Boolean  @default(true)

  /* --- Dates --- */
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}


model Project {
  id                  String      @id @default(uuid())
  title               String
  description         String
  pme                 PME         @relation(fields: [pmeId], references: [id], onDelete: Cascade)
  pmeId               String
  status              ProjectStatus @default(pending)
  requestedAmount     Float
  fundedAmount        Float?
  fundDisbursementDates DateTime[]
   documents              Document[]
  validatedAt         DateTime?
  currentStepOrder   Int?
  stepProgress           ProjectStepProgress[]
 activity          Activity[]
 credits            ProjectCredit[]
  statusHistory ProjectStatusHistory[]
 hasCredit        Boolean
 meetingProject      MeetingProjectDecision[]
  campaignId    String
  campaign      Campaign @relation(fields: [campaignId], references: [id])
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  @@index([status])
  @@index([createdAt])
  @@unique([campaignId, pmeId])
}

model ProjectStatusHistory {
  id        String @id @default(uuid())

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  status    ProjectStatus   // approved, funded, failed, etc.
  changedAt DateTime        @default(now())


  createdAt DateTime @default(now())

  @@index([projectId, status])
}



model ProjectStepProgress {
  id             String   @id @default(uuid())

  projectId      String
  project        Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  campaignStepId String
  campaignStep   CampaignStep @relation(fields: [campaignStepId], references: [id])

  status         StepStatus @default(PENDING)

  validatedAt    DateTime?
  comment        String?
  stepDocuments   Document[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([projectId, campaignStepId])
  @@index([status])
}


model Document {
  id          String   @id @default(uuid())

  // M√©tadonn√©es
  title       String
  fileUrl     String
  publicId    String
  mimeType    String?
  size        Int ?    

  // Relation
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId   String

  projectStepId  String
  projectStep    ProjectStepProgress @relation(fields: [projectStepId], references: [id], onDelete: Cascade)


  
  // Audit
  createdAt   DateTime @default(now())
}

model Activity {
  id        String   @id @default(uuid())
  type      ActivityType
  title     String
  message   String

  pmeId     String?
  pme       PME?      @relation(fields: [pmeId], references: [id])

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])

  userId    String
  user      User    @relation(fields: [userId], references: [id])

  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

model Campaign {
  id          String          @id @default(uuid())
  name        String
  description String
  start_date  DateTime
  end_date    DateTime
  status      CampaignStatus  @default(DRAFT)
  committees   Committee[]
  steps       CampaignStep[]
 projects      Project[]
 targetProjects Int? 
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([status])
  @@index([start_date, end_date])
}



model CampaignStep {
  id          String   @id @default(uuid())

  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id])

  name        String       
  order       Int

  committee   Committee?    

  setsProjectStatus   ProjectStatus?   
 
 
  createdAt   DateTime @default(now())
   projectSteps ProjectStepProgress[]
  @@unique([campaignId, order])
}

 

enum CampaignStatus {
  DRAFT
  OPEN
  CLOSED
}




enum ActivityType {
  WELCOME
  PROJECT_CREATED
  PROJECT_APPROVED
  PROJECT_REJECTED
  ACCOUNT_VERIFIED
}



enum ProjectStatus {
  pending
  approved
  rejected
  funded
  completed
  failed
  suspended
}






model Committee {
  id          String   @id @default(uuid())
  name        String
  description String?

 campaignId    String
  campaign      Campaign @relation(fields: [campaignId], references: [id])
  
  members     CommitteeMember[]
  meetings    CommitteeMeeting[]

  stepId        String   @unique
  step          CampaignStep @relation(fields: [stepId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
}


model CommitteeMember {
  id          String @id @default(uuid())

  committeeId String
  userId      String

  memberRole        CommitteeRole

  committee   Committee @relation(fields: [committeeId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

 presences   MeetingPresence[]
 signatures  ReportSignature[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([committeeId, userId])
}



model CommitteeMeeting {
  id           String @id @default(uuid())

  committeeId  String
  committee    Committee @relation(fields: [committeeId], references: [id], onDelete: Cascade)

  date         DateTime
  startTime    DateTime
  endTime      DateTime
  location     String

  status       MeetingStatus @default(PROGRAMMED)

  presences    MeetingPresence[]
  report       MeetingReport?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}


model MeetingPresence {
  id          String @id @default(uuid())

  meetingId   String
  memberId    String

  meeting     CommitteeMeeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  member      CommitteeMember  @relation(fields: [memberId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@unique([meetingId, memberId])
}



model MeetingReport {
  id             String @id @default(uuid())

  meetingId      String @unique
  meeting        CommitteeMeeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  status         ReportStatus @default(DRAFT)
  otherDecisions String?

  projectDecisions MeetingProjectDecision[]
  documents       ReportDocument[]
  signatures      ReportSignature[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model MeetingProjectDecision {
  id          String @id @default(uuid())

  reportId    String
  report      MeetingReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  projectId   String
  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  decision    CommitteeDecision
  note        String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([reportId, projectId])
}

model ReportSignature {
  id          String @id @default(uuid())

  reportId    String
  memberId    String

  signedAt    DateTime @default(now())

  report      MeetingReport  @relation(fields: [reportId], references: [id], onDelete: Cascade)
  member      CommitteeMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([reportId, memberId])
}

model ReportDocument {
  id        String @id @default(uuid())

  reportId  String
  report    MeetingReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  label     String
  fileUrl   String
  publicId  String

  createdAt DateTime @default(now())
}






model ProjectCredit {
  id               String   @id @default(uuid())
  borrower   String

  amount           Float
  interestRate     Float
  monthlyPayment   Float
  remainingBalance Float
  dueDate          DateTime

  projectId        String
  project          Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([projectId])
}





enum CommitteeRole {
  president
  vice_president
  member
  secretary
}

enum CommitteeDecision {
  approved
  rejected
  suspended
}

enum MeetingStatus {
  PROGRAMMED
  ONGOING
  FINISHED
  POSTPONED
  CANCELED
}

enum ReportStatus {
  DRAFT
  APPLIED
}



enum PMESize {
  small
  middle
}

enum PMEType {
  non_profit
  for_profit
  ong
}


enum StepStatus {
  PENDING
  IN_PROGRESS
  APPROVED
  REJECTED
}

enum Role {
  SUPER_ADMIN
  ADMIN
  PME
  FINANCIER
}






       