// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
  previewFeatures = ["relationJoins"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String    @id @default(uuid()) @unique

  // Identit√©
  email          String    @unique
  passwordHash   String
  firstName      String?
  lastName       String?

  // R√¥le & permissions
  role           Role      @default(PME)
  isActive       Boolean   @default(false)


  

  // S√©curit√©
  lastLoginAt    DateTime?
  failedLogins   Int       @default(0)
  isLocked       Boolean   @default(false)
  tokens          RefreshToken[]
  // Audit & suivi
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  validatedAt         DateTime?
  verificationCode     String?
  codeExpires           DateTime?
  codeIsVerified         Boolean  @default(false)

  // Relations
  validatedProjects      Project[]       @relation("ProjectValidators")
  validatedSubSteps      SubStep[]       @relation("SubStepValidators")

  pme            PME?   
  activity          Activity[]  
  committeMember      CommitteeMember[]
  

}

enum Role {
  SUPER_ADMIN
  ADMIN
  PME
  FINANCIER
}


model RefreshToken {
  id        String    @id @default(uuid())
  token     String    @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime  @default(now())
  revokedAt DateTime? // üëà NOUVEAU CHAMP
 
  user User @relation(fields: [userId], references: [id])
}


model PME {
  id          String   @id @default(uuid())

  /* --- Identit√© --- */
  name        String
  type        PMEType
  size        PMESize
  description String

  /* --- Contact --- */
  email       String   @unique
  phone       String
  website     String?
  logoUrl     String?
  logoId      String?

  /* --- Localisation --- */
  address     String
  city        String
  country     String

  /* --- R√¥le utilisateur --- */
  userRole    String?

  /* --- Relations --- */
  projects    Project[]
  activity          Activity[]

  ownerId     String   @unique
  owner       User     @relation(fields: [ownerId], references: [id])

  /* --- Statut --- */
  isActive    Boolean  @default(true)

  /* --- Dates --- */
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}


model Project {
  id                  String      @id @default(uuid())
  title               String
  description         String
  pme                 PME         @relation(fields: [pmeId], references: [id], onDelete: Cascade)
  pmeId               String
  status              ProjectStatus @default(pending)
  requestedAmount     Float
  fundedAmount        Float?
  fundDisbursementDates DateTime[]
   documents              Document[]
  validatedBy         User[]      @relation("ProjectValidators")
  validatedAt         DateTime?
  subSteps            SubStep[]
 activity          Activity[]
 credit            Float?
 hasCredit        Boolean
 meetingProject      MeetingProjectDecision[]
  submissionDate      DateTime    @default(now())
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
}

model Document {
  id          String   @id @default(uuid())

  // M√©tadonn√©es
  title       String
  fileUrl     String
  publicId    String
  mimeType    String?
  size        Int?     // taille en bytes (optionnel)

  // Relation
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId   String

  
  // Audit
  createdAt   DateTime @default(now())
}

model Activity {
  id        String   @id @default(uuid())
  type      ActivityType
  title     String
  message   String

  pmeId     String?
  pme       PME?      @relation(fields: [pmeId], references: [id])

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])

  userId    String
  user      User    @relation(fields: [userId], references: [id])

  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}



enum ActivityType {
  WELCOME
  PROJECT_CREATED
  PROJECT_APPROVED
  PROJECT_REJECTED
  ACCOUNT_VERIFIED
}



enum ProjectStatus {
  pending
  approved
  rejected
  funded
  completed
  failed
  suspended
}

model SubStep {
  id           String      @id @default(uuid())
  name         String
  description  String?
  state        SubStepState @default(pending)
  dueDate      DateTime?
  completedAt  DateTime?
  remarks      String?

  project      Project     @relation(fields: [projectId], references: [id])
  projectId    String
  validatedBy  User[]      @relation("SubStepValidators")

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
}

enum SubStepState {
  pending
  in_progress
  validated
  failed
}

enum PMESize {
  small
  middle
}

enum PMEType {
  non_profit
  for_profit
}



model Committee {
  id          String   @id @default(uuid())
  name        String
  description String?

  members     CommitteeMember[]
  meetings    CommitteeMeeting[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}


model CommitteeMember {
  id          String @id @default(uuid())

  committeeId String
  userId      String

  memberRole        CommitteeRole

  committee   Committee @relation(fields: [committeeId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

 presences   MeetingPresence[]
 signatures  ReportSignature[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([committeeId, userId])
}



model CommitteeMeeting {
  id           String @id @default(uuid())

  committeeId  String
  committee    Committee @relation(fields: [committeeId], references: [id], onDelete: Cascade)

  date         DateTime
  startTime    DateTime
  endTime      DateTime
  location     String

  status       MeetingStatus @default(PROGRAMMED)

  presences    MeetingPresence[]
  report       MeetingReport?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}


model MeetingPresence {
  id          String @id @default(uuid())

  meetingId   String
  memberId    String

  meeting     CommitteeMeeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  member      CommitteeMember  @relation(fields: [memberId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@unique([meetingId, memberId])
}



model MeetingReport {
  id             String @id @default(uuid())

  meetingId      String @unique
  meeting        CommitteeMeeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  status         ReportStatus @default(DRAFT)
  otherDecisions String?

  projectDecisions MeetingProjectDecision[]
  documents       ReportDocument[]
  signatures      ReportSignature[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model MeetingProjectDecision {
  id          String @id @default(uuid())

  reportId    String
  report      MeetingReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  projectId   String
  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  decision    CommitteeDecision
  note        String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([reportId, projectId])
}

model ReportSignature {
  id          String @id @default(uuid())

  reportId    String
  memberId    String

  signedAt    DateTime @default(now())

  report      MeetingReport  @relation(fields: [reportId], references: [id], onDelete: Cascade)
  member      CommitteeMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([reportId, memberId])
}

model ReportDocument {
  id        String @id @default(uuid())

  reportId  String
  report    MeetingReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  label     String
  fileUrl   String
  publicId  String

  createdAt DateTime @default(now())
}











enum CommitteeRole {
  president
  vice_president
  member
  secretary
}

enum CommitteeDecision {
  approved
  rejected
  suspended
}

enum MeetingStatus {
  PROGRAMMED
  ONGOING
  FINISHED
  POSTPONED
  CANCELED
}

enum ReportStatus {
  DRAFT
  APPLIED
}





       